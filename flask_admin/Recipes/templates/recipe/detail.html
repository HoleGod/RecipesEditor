{% extends 'base.html' %}

{% block content %}
<style>
	.rating {
	  direction: rtl;
	  display: inline-flex;
	  gap: 4px;
	}
	.rating input {
	  display: none;
	}
	.rating label {
	  font-size: 2rem;
	  color: #ccc;
	  cursor: pointer;
	  transition: color 0.2s;
	}
	.rating input:checked ~ label {
	  color: gold;
	}
	.rating label:hover,
	.rating label:hover ~ label {
	  color: gold;
	}
	.btn-group-right {
	  display: flex;
	  justify-content: flex-end;
	  gap: 8px;
	}
	.badge-admin { background-color: #dc3545; color: white; }
	.badge-moderator { background-color: #ffc107; color: #212529; }
	.badge-user { background-color: #6c757d; color: white; }
</style>

<div class="container my-4">
	<div class="card">
		<div class="card-body">
			<div class="d-flex justify-content-end mb-3">
				<a href="{{ url_for('recipe.home', featured=featured, other_recipes=other_recipes) }}" class="btn btn-primary">
					Return to home page...
				</a>
			</div>

			<h1 class="card-title">{{ recipe.title }}</h1>
			<p class="text-muted">Author: {{ recipe.user.name }}</p>

			<form action="{{ url_for('recipe.fav', recipe_id=recipe.id) }}" method="POST" class="mb-3">
				{% set is_fav = g.user.favorites | selectattr('recipe_id', 'equalto', recipe.id) | list | length > 0 %}
				<button type="submit" class="btn {{ 'btn-danger' if is_fav else 'btn-outline-primary' }}">
				  {{ 'Favorite' if is_fav else 'Add to favorites' }}
				</button>
			</form>

			{% if recipe.image_filename %}
				<img src="{{ url_for('static', filename=recipe.image_filename) }}"
					 alt="{{ recipe.image_alt or 'Recipe image' }}"
					 class="img-fluid rounded mb-3">
				<div class="mb-3">
					{% if recipe.categories %}
						<p><strong>Categories:</strong>
						{% for category in recipe.categories %}
							<span class="badge bg-info text-dark">{{ category.name }}</span>
						{% endfor %}
						</p>
					{% endif %}
					
					{% if recipe.tags %}
						<p><strong>Tags:</strong>
						{% for tag in recipe.tags %}
							<span class="badge bg-secondary">{{ tag.name }}</span>
						{% endfor %}
						</p>
					{% endif %}
				</div>
			{% endif %}
			<p class="lead">{{ recipe.short_description }}</p>

			<h4>Ingredients</h4>
			<pre class="bg-light p-3 rounded">{{ recipe.ingredients }}</pre>

			<h4>Instruction</h4>
			<pre class="bg-light p-3 rounded">{{ recipe.instruction }}</pre>

			{% if recipe.notes %}
				<h4>Notes</h4>
				<pre class="bg-light p-3 rounded">{{ recipe.notes }}</pre>
			{% endif %}
			{% if g.user.id == recipe.user_id %}
				<div class="btn-group-right mb-3 gap-3">
					<a href="{{ url_for('recipe.edit_recipe', recipe_id=recipe.id) }}" class="btn btn-warning btn-sm">Edit</a>
					<form action="{{ url_for('recipe.delete_recipe', recipe_id=recipe.id) }}" method="POST" style="margin: 0;">
					<button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('You really want to delete this recipe?');">
						Delete
					</button>
					</form>
				</div>
			{% endif %}

			<form action="{{ url_for('recipe.get_rate', recipe_id=recipe.id) }}" method="post" class="d-flex align-items-center gap-2">
				<div class="rating mb-0">
				  {% for i in range(5, 0, -1) %}
					<input type="radio" id="star{{i}}" name="rating" value="{{i}}" {% if user_rating == i %}checked{% endif %}>
					<label for="star{{i}}">&#9733;</label>
				  {% endfor %}
				</div>
				<button type="submit" class="btn btn-primary btn-sm">Set</button>
			</form>
			{% if recipe.average_rating %}
				<p class="lead">Average rating: <strong>{{ recipe.average_rating | round(1) }}</strong></p>
			{% else %}
				<p class="lead">No ratings yet</p>
			{% endif %}

			<hr>

			<h2 class="card-title">Comments</h2>
			<form action="{{ url_for('recipe.add_comment', recipe_id=recipe.id) }}" class="mb-3 d-flex" method="POST">
				<textarea name="text" id="text" class="form-control me-2" placeholder="Write your comment" required></textarea>
				<button type="submit" class="btn btn-outline-primary">Create</button>
			</form>

			{% if comments %}
				{% for c in comments %}
					<div class="card mb-3 shadow-sm border-0 rounded-3">
						<div class="card-body p-3">
							<div class="d-flex justify-content-between align-items-center mb-2">
								<span class="badge fs-6 
									{% if c.user.role == 'admin' %}badge-admin
									{% elif c.user.role == 'moderator' %}badge-moderator
									{% else %}badge-user{% endif %}">
									{{ c.author }}
								</span>
								<small class="text-muted fst-italic">{{ c.created_at.strftime('%d %b %Y, %H:%M') }}</small>
							</div>
							
							<p class="text-dark mb-0" style="white-space: pre-wrap;">{{ c.text }}</p>
						</div>
						<div class="btn-group-right mb-3 gap-3">
							{% if g.user.role == 'user' and g.user.id == c.user_id %}
								<button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editCommentModal{{ c.id }}">
									Edit
								</button>                            
								<form action="{{ url_for('recipe.delete_comment', recipe_id=recipe.id, comment_id=c.id) }}" method="POST" style="margin: 0;">
									<button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('You really want to delete this comment?');">
										Delete
									</button>
								</form>
							{% elif g.user.role == 'moderator' or g.user.role == 'admin' %}
								<button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editCommentModal{{ c.id }}">
									Edit
								</button>
								<form action="{{ url_for('recipe.delete_comment', recipe_id=recipe.id, comment_id=c.id) }}" method="POST" style="margin: 0;">
									<button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('You really want to delete this comment?');">
										Delete
									</button>
								</form>
							{% endif %}  
						</div>												
					</div>	
					<div class="modal fade" id="editCommentModal{{ c.id }}" tabindex="-1" aria-labelledby="editCommentModalLabel{{ c.id }}" aria-hidden="true">
						<div class="modal-dialog">
						  <form action="{{ url_for('recipe.edit_comment', recipe_id=recipe.id, comment_id=c.id) }}" method="POST" class="modal-content">
							<div class="modal-header">
							  <h5 class="modal-title" id="editCommentModalLabel{{ c.id }}">Edit Comment</h5>
							  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
							  <input type="hidden" name="comment_id" value="{{ c.id }}">
							  <div class="mb-3">
								<textarea name="text" class="form-control" rows="4">{{ c.text }}</textarea>
							  </div>
							</div>
							<div class="modal-footer">
							  <button type="submit" class="btn btn-primary">Save changes</button>
							  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
							</div>
						  </form>
						</div>
					  </div>							
				{% endfor %}
			{% else %}
				<p class="text-muted">No comments yet!</p>
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}

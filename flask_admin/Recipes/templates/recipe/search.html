{% extends 'base.html' %}

{% block title %}Search Results{% endblock %}

{% block head %}
<style>
	#search-results .card {
		transition: transform 0.2s ease-in-out;
	}
	#search-results .card:hover {
		transform: scale(1.05);
	}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
	<h2 class="mb-4">Search Results for "{{ query }}"</h2>

	<div id="search-results" class="row g-4">
		{% if recipes %}
			{% for recipe in recipes %}
			<div class="col-md-4">
				<div class="card h-100 shadow-sm">
					{% if recipe.image_filename %}
						<img src="{{ url_for('static', filename=recipe.image_filename) }}" 
							 alt="Recipe image" 
							 class="card-img-top" 
							 style="height: 200px; object-fit: cover;">
					{% endif %}
					<div class="card-body">
						<h5 class="card-title">{{ recipe.title }}</h5>
						<p class="text-muted mb-2">Author: {{ recipe.user.name }}</p>
						<p class="card-text">{{ recipe.short_description[:100] }}...</p>
						<a href="{{ url_for('recipe.show_recipe', recipe_id=recipe.id) }}" 
						   class="btn btn-sm btn-outline-primary">View</a>
					</div>
				</div>
			</div>
			{% endfor %}
		{% else %}
			<p class="text-center my-5">No recipes found matching your search.</p>
		{% endif %}
	</div>
</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function() {
	const searchInput = document.querySelector('input[name="q"]');
	const resultsContainer = document.getElementById('search-results');
	const heading = document.querySelector('h2.mb-4');

	if (!searchInput || !resultsContainer || !heading) return;

	let debounceTimeout;

	searchInput.addEventListener('input', function() {
		clearTimeout(debounceTimeout);

		const query = this.value.trim();

		if (query.length > 0) {
			heading.textContent = `Search Results for "${query}"`;
		} else {
			heading.textContent = 'Search Results';
		}

		if (query.length < 2) {
			resultsContainer.innerHTML = '<p class="text-center my-5">Please enter at least 2 characters to search.</p>';
			return;
		}

		debounceTimeout = setTimeout(() => {
			fetch(`/search_api?q=${encodeURIComponent(query)}`, {
				headers: {
					'Accept': 'application/json'
				}
			})
			.then(response => response.json())
			.then(data => {
				if (data.length === 0) {
					resultsContainer.innerHTML = '<p class="text-center my-5">No recipes found.</p>';
					return;
				}

				const cardsHtml = data.map(recipe => `
					<div class="col-md-4">
						<div class="card h-100 shadow-sm">
							${recipe.image ? `<img src="/static/${recipe.image}" alt="Recipe image" class="card-img-top" style="height: 200px; object-fit: cover;">` : ''}
							<div class="card-body">
								<h5 class="card-title">${recipe.title}</h5>
								<p class="text-muted mb-2">Author: ${recipe.author_name}</p>
								<p class="card-text">${recipe.short_description ? recipe.short_description.substring(0, 100) + '...' : ''}</p>
								<a href="/recipe/${recipe.id}" class="btn btn-sm btn-outline-primary">View</a>
							</div>
						</div>
					</div>
				`).join('');

				resultsContainer.innerHTML = cardsHtml;
			})
			.catch(err => {
				resultsContainer.innerHTML = '<p class="text-center my-5 text-danger">Error loading search results.</p>';
				console.error(err);
			});
		}, 300);
	});
});
</script>
{% endblock %}